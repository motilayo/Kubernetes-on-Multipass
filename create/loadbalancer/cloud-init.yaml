#cloud-init

# create ssh passwordless user
users:
  - name: ubuntu
    home: /home/ubuntu
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC1ebqOn1oqkDDKoji6fRO595p0MRh+5Yr18PjKK/GsrxGTaxYr2Hn+LrP7neIxn9TrY4YgKYgGykAdxwz+er7eG3Ws51P7NoUe9Lrfd2ER/jpEsSRK+zCmfp5qK41i5mm7fg1RdVvxY75YT9h22ZSaitIyVEAW53kqCQcFk/aHoS9H1nfk5xjfiPZ/M6EqRWaLa5kTblDksqFrgWMWVfRpTI2Pit3eGNv8AQ6xrO0FMZAZyGxjH2pcK+EhGXyb4EqlqgP495Rvvm81d4eEuOijeFDpxka+HYfIF8twv5ijxNu80J+OFAhYZzPpBYEz+7PqD85PzZmLtoILlDvKREsfhDgcTJhdffRrlm/cF0WGGbLAeY3ITEKwB9XFdoSfppnlZ078KCk+02vt+loPThSNZu80PFTh1nvu31751ocBhaH5rUr0LQJfFvX0XNY6L6hMo11kuR9pNC70R4PBH5/Gwmel6W5qF9yphcalw+seykG7FnXx/U4UrLVeezuF4qKN5F8TLVa6/EuJ9KhwRGXHZg6oTvVxLRkZ1pn6YglT6AXCMVU1Y1CRXPWVJhtOhshv40bSamvj7U80s5Zajn8aUxckjKcx6BRY1bOgml5SbFWp27d2wOkLMyrYASjRsiumxlMefcTUi5Cmr9zbHC0fZFYlYknTd86NYu35WLN7bw==

# install needed packages      
package_update: true
package_upgrade: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - haproxy

# create files
write_files:
  - path: /etc/systemd/resolved.conf
    append: true
    content: |
      MulticastDNS=yes

  - path: /etc/systemd/system/mdns@.service
    content: |
      [Service]
      Type=oneshot
      ExecStart=/usr/bin/systemd-resolve --set-mdns=yes --interface=%i
      After=sys-subsystem-net-devices-%i.device

      [Install]
      WantedBy=sys-subsystem-net-devices-%i.device

runcmd:
  - sudo swapoff -a
  - systemctl restart systemd-resolved.service
  - systemctl start mdns@enp0s2.service
  - systemctl enable mdns@enp0s2.service

package_reboot_if_required: true