---
- name: hold packages
  shell: apt-mark hold kubelet kubeadm kubectl

- name: kubeadm reset
  shell: kubeadm reset --force && kubeadm reset phase cleanup-node

- name: get kubeadm certificate key
  shell: kubeadm certs certificate-key
  register: certificate_key
  delegate_to: "{{ groups.control[0] }}"

- name: create .kube directory
  become_user: ubuntu
  file:
    path: $HOME/.kube
    state: directory
    mode: 0755
  register: kube_path

- name: get kubeadm certificate key
  shell: kubeadm certs certificate-key
  register: CERT_KEY
  delegate_to: "{{ groups.control[0] }}"

- name: upload certificate
  shell: kubeadm init phase upload-certs --upload-certs --certificate-key={{ CERT_KEY.stdout }}
  delegate_to: "{{ groups.control[0] }}"

- name: get join command
  become: false
  shell: kubeadm token create --print-join-command --certificate-key={{ CERT_KEY.stdout }}
  register: JOIN_COMMAND
  delegate_to: "{{ groups.control[0] }}"
  
- name: set facts join command
  set_fact:
    join_command: "{{ JOIN_COMMAND.stdout }}"

- name: debug join command
  debug:
    msg:
      - "{{ join_command }}"

- name: join other control plane nodes
  shell: "{{ join_command }}"
  # shell: kubeadm join --config ./kubeadm-join-config.yaml
  register: join_cmd_output

- name: debug join control plane nodes
  debug:
    msg:
      - "{{ join_cmd_output.stdout }}"