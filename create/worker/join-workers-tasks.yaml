---
- name: hold packages
  shell: apt-mark hold kubelet kubeadm kubectl

- name: kubeadm reset
  shell: kubeadm reset --force && kubeadm reset phase cleanup-node

- name: get join command for workers
  shell: kubeadm token create --print-join-command
  register: JOIN_COMMAND
  delegate_to: "{{ groups.control[0] }}"

- name: set facts join command & cert
  set_fact:
    join_command: "{{ JOIN_COMMAND.stdout }}"

- name: debug join command
  debug:
    msg: 
      - "{{ join_command }}"

- name: join cluster
  shell: "{{ join_command }}"
  register: join_worker_output

- name: debug join worker nodes
  debug:
    msg:
      - "{{ join_worker_output.stdout }}"
